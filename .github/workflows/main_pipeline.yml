# Version: 0.9.12
# License: MIT
# Code generated with support from CODEX and CODEX CLI.
# Owner / Idea / Management: Dr. Babak Sorkhpour (https://x.com/Drbabakskr)
name: main_pipeline

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  select-tests:
    runs-on: ubuntu-latest
    outputs:
      run_android: ${{ steps.pick.outputs.run_android }}
      run_gadget: ${{ steps.pick.outputs.run_gadget }}
      run_brain: ${{ steps.pick.outputs.run_brain }}
      reason: ${{ steps.pick.outputs.reason }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Collect changed files
        id: changed
        uses: tj-actions/changed-files@v45
      - name: Run PTS selector
        id: pick
        run: |
          python3 scripts/pts_selector.py --changed-files ${{ steps.changed.outputs.all_changed_files }} > pts.json
          cat pts.json
          echo "run_android=$(jq -r '.run_android' pts.json)" >> "$GITHUB_OUTPUT"
          echo "run_gadget=$(jq -r '.run_gadget' pts.json)" >> "$GITHUB_OUTPUT"
          echo "run_brain=$(jq -r '.run_brain' pts.json)" >> "$GITHUB_OUTPUT"
          echo "reason=$(jq -r '.reason' pts.json)" >> "$GITHUB_OUTPUT"

  logic-verification:
    name: Logic Verification (BDD)
    runs-on: ubuntu-latest
    needs: select-tests
    if: needs.select-tests.outputs.run_brain == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r proto/python/requirements.txt
          pip install pytest pytest-bdd
      - name: Run BDD suite
        run: |
          pytest -q tests/bdd | tee pytest_output.log
      - name: Failure diagnostics
        if: failure()
        run: |
          python3 scripts/diagnose_failure.py --pytest-log pytest_output.log --system-log pytest_output.log --output failure_report.zip
      - name: Upload diagnostics artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-report-brain
          path: failure_report.zip

  android-build:
    name: Android Build + Unit Tests
    runs-on: ubuntu-latest
    needs: select-tests
    if: needs.select-tests.outputs.run_android == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - name: Ensure gradle wrapper
        run: |
          if [ ! -f mobile/android/gradlew ]; then
            echo "missing mobile/android/gradlew" >&2
            exit 1
          fi
      - name: Build release APK
        run: |
          cd mobile/android
          ./gradlew :app:assembleRelease
      - name: Run Android unit tests
        run: |
          cd mobile/android
          ./gradlew :app:testDebugUnitTest
      - name: Failure diagnostics
        if: failure()
        run: |
          python3 scripts/diagnose_failure.py --system-log mobile/android/app/build/reports/tests/testDebugUnitTest/index.html --output failure_report.zip
      - name: Upload diagnostics artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-report-android
          path: failure_report.zip

  gadget-build:
    name: Gadget Docker Build + Integration Tests
    runs-on: ubuntu-latest
    needs: select-tests
    if: needs.select-tests.outputs.run_gadget == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Build gadget runtime image
        run: |
          docker build -t ampel-gadget:ci -f hal/runtime/Dockerfile .
      - name: Run gadget integration tests
        run: |
          pytest -q tests | tee pytest_output.log
      - name: Failure diagnostics
        if: failure()
        run: |
          python3 scripts/diagnose_failure.py --pytest-log pytest_output.log --system-log pytest_output.log --output failure_report.zip
      - name: Upload diagnostics artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-report-gadget
          path: failure_report.zip
